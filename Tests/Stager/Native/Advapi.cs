using System;
using System.Collections.Generic;
using System.Linq;
using System.Runtime.InteropServices;
using System.Text;
using System.Threading.Tasks;

namespace Stager.Native
{
	public static class Advapi
	{
		[DllImport("advapi32.dll")]
		public static extern bool LogonUserA(
			string lpszUsername,
			string lpszDomain,
			string lpszPassword,
			LogonProvider dwLogonType,
			LogonUserProvider dwLogonProvider,
			ref IntPtr phToken);

		[DllImport("advapi32.dll")]
		public static extern bool OpenProcessToken(
			IntPtr ProcessHandle,
			DesiredAccess DesiredAccess,
			out IntPtr TokenHandle);

		[DllImport("advapi32.dll")]
		public extern static bool DuplicateTokenEx(
			IntPtr hExistingToken,
			TokenAccess dwDesiredAccess,
			ref SECURITY_ATTRIBUTES lpTokenAttributes,
			SecurityImpersonationLevel ImpersonationLevel,
			TokenType TokenType,
			out IntPtr phNewToken);

		[DllImport("advapi32.dll")]
		public static extern bool ImpersonateLoggedOnUser(IntPtr hToken);

		[DllImport("advapi32.dll")]
		public static extern bool RevertToSelf();

		[StructLayout(LayoutKind.Sequential)]
		public struct SECURITY_ATTRIBUTES
		{
			public int nLength;
			public IntPtr lpSecurityDescriptor;
			public int bInheritHandle;
		}

		public enum LogonProvider
		{
			LOGON32_LOGON_INTERACTIVE = 2,
			LOGON32_LOGON_NETWORK = 3,
			LOGON32_LOGON_BATCH = 4,
			LOGON32_LOGON_SERVICE = 5,
			LOGON32_LOGON_UNLOCK = 7,
			LOGON32_LOGON_NETWORK_CLEARTEXT = 8,
			LOGON32_LOGON_NEW_CREDENTIALS = 9
		}

		public enum LogonUserProvider
		{
			LOGON32_PROVIDER_DEFAULT = 0,
			LOGON32_PROVIDER_WINNT35 = 1,
			LOGON32_PROVIDER_WINNT40 = 2,
			LOGON32_PROVIDER_WINNT50 = 3,
			LOGON32_PROVIDER_VIRTUAL = 4
		}

		public enum DesiredAccess : uint
		{
			STANDARD_RIGHTS_REQUIRED = 0x000F0000,
			STANDARD_RIGHTS_READ = 0x00020000,
			TOKEN_ASSIGN_PRIMARY = 0x0001,
			TOKEN_DUPLICATE = 0x0002,
			TOKEN_IMPERSONATE = 0x0004,
			TOKEN_QUERY = 0x0008,
			TOKEN_QUERY_SOURCE = 0x0010,
			TOKEN_ADJUST_PRIVILEGES = 0x0020,
			TOKEN_ADJUST_GROUPS = 0x0040,
			TOKEN_ADJUST_DEFAULT = 0x0080,
			TOKEN_ADJUST_SESSIONID = 0x0100,
			TOKEN_READ = (STANDARD_RIGHTS_READ | TOKEN_QUERY),

			TOKEN_ALL_ACCESS = (STANDARD_RIGHTS_REQUIRED | TOKEN_ASSIGN_PRIMARY |
			TOKEN_DUPLICATE | TOKEN_IMPERSONATE | TOKEN_QUERY | TOKEN_QUERY_SOURCE |
			TOKEN_ADJUST_PRIVILEGES | TOKEN_ADJUST_GROUPS | TOKEN_ADJUST_DEFAULT |
			TOKEN_ADJUST_SESSIONID)
		}

		public enum TokenAccess : uint
		{
			TOKEN_ASSIGN_PRIMARY = 0x0001,
			TOKEN_DUPLICATE = 0x0002,
			TOKEN_IMPERSONATE = 0x0004,
			TOKEN_QUERY = 0x0008,
			TOKEN_QUERY_SOURCE = 0x0010,
			TOKEN_ADJUST_PRIVILEGES = 0x0020,
			TOKEN_ADJUST_GROUPS = 0x0040,
			TOKEN_ADJUST_DEFAULT = 0x0080,
			TOKEN_ADJUST_SESSIONID = 0x0100,
			TOKEN_ALL_ACCESS_P = 0x000F00FF,
			TOKEN_ALL_ACCESS = 0x000F01FF,
			TOKEN_READ = 0x00020008,
			TOKEN_WRITE = 0x000200E0,
			TOKEN_EXECUTE = 0x00020000
		}

		public enum TokenType
		{
			TOKEN_PRIMARY = 1,
			TOKEN_IMPERSONATION
		}

		public enum SecurityImpersonationLevel
		{
			SECURITY_ANONYMOUS,
			SECURITY_IDENTIFICATION,
			SECURITY_IMPERSONATION,
			SECURITY_DELEGATION
		}
	}
}
